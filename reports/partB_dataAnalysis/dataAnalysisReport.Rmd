---
params:
  subtitle: ""
  title: ""
  authors: ""
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r getRunDateTime()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
bibliography: '`r paste0(here::here(), "/bibliography.bib")`'
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```


```{r codeSetup, include=FALSE}
# Set start time ----
startTime <- proc.time()
# Local parameters ----
b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576
plotLoc <- paste0(repoParams$repoLoc, "/docs/plots/") # where to put the plots (if any)

# Packages used in the report ----
libs <- c("ggplot2", # plots
          "kableExtra", # fancy tables
          "skimr" # for skim
          )
          
# Local functions ----
```

\newpage

# About

## Citation

```{r citation, child=repoParams$citation}
```

## Report circulation:

 * Public â€“ this report is intended for publication.
 
## License

```{r ccby license, child=repoParams$licenseCCBY}
```
 
## History

```{r history, child=repoParams$history}
```
 * this [report's edit history](https://github.com/CfSOtago/GREENGridEECA/commits/master/reports/partB_dataAnalysis)
 
## Support

```{r generic support, child=repoParams$support}
```
 
\newpage

# Introduction

This report uses the GREEN Grid project [@stephenson_smart_2017] research data to...

# Data

```{r generic sample, child=repoParams$data}
```
 
# Peak Contribution

```{r peakContrib}
# use allDataDT created in the makeFile
```

# Annual Contribution

# Conservation Load Factor

# Summary

# Data Annex

Descriptive statistics for aggregate half hourly power data for all households and all circuits:

```{r skimData}
skimr::skim(allDataDT)
```

The following tables show descriptive statistics for the meanPowerW values for each circuit by household.

```{r powerCube, results = "asis"}
ids <- unique(allDataDT$linkID)

for(hh in ids){
  # prints a lot of tables
    t <- data.table::cube(allDataDT[linkID == hh], j = c(list(meanPowerW = mean(meanPowerW),
                                                              minPowerW = min(meanPowerW),
                                                              maxPowerW = max(meanPowerW),
                                                              nObs = .N)), by = c("circuit"))
    # NA in circuit column of ersults table = All
    t[, circuit := ifelse(is.na(circuit), "All", circuit)]
    print(kableExtra::kable(t, caption = paste0(hh, ": Mean of half-hourly mean power (W) by circuit type")) %>% 
      kable_styling())
}

```

```{r Part B: data processing}

#New DT
origDT <- allDataDT

#DT modifications

#Excluding households based on report and setting negative values to zero
origDT <- origDT[!(origDT$linkID=="rf_14"),]
origDT <- origDT[!(origDT$linkID=="rf_25"),]
origDT <- origDT[!(origDT$linkID=="rf_26"),]
origDT <- origDT[!(origDT$linkID=="rf_43"),]
origDT <- origDT[!(origDT$linkID=="rf_46"),]

origDT <- origDT[, meanPowerW := ifelse(meanPowerW <0, NA, meanPowerW)]
origDT <- origDT[, sdPowerW := ifelse(sdPowerW <0, NA, sdPowerW)]
origDT <- origDT[, minPowerW := ifelse(minPowerW <0, NA, minPowerW)]
origDT <- origDT[, maxPowerW := ifelse(maxPowerW <0, NA, maxPowerW)]


#Define Winter/else
origDT <- origDT[, date := lubridate::date(r_dateTimeHalfHour)]
origDT <- origDT[, obsHalfHour := format(ymd_hms(r_dateTimeHalfHour), "%H:%M:%S")]
origDT <- origDT[, month := lubridate::month(r_dateTimeHalfHour)]

origDT <- origDT[month >= 12 | month == 1 | month == 2, season := "Summer"]
origDT <- origDT[month >= 3 | month == 4 | month == 5, season := "Autumn"]
origDT <- origDT[month == 6 | month == 7 | month == 8, season := "Winter"]
origDT <- origDT[month == 9 | month == 10 | month == 11, season := "Spring"]

#Setting times of peak demand 
OPS1 <- hms::as.hms("00:00:00")
OPE1 <- hms::as.hms("16:30:00")

PS <- hms::as.hms("17:00:00")
PE <- hms::as.hms("21:00:00")

OPS2 <- hms::as.hms("21:30:00")
OPE2 <- hms::as.hms("23:30:00")
#----------------------------
#Actual calculations start
#----------------------------

```

```{r Part B: calculations}

u














```

# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime
elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

## R packages used

 * base R [@baseR]
 * bookdown [@bookdown]
 * data.table [@data.table]
 * ggplot2 [@ggplot2]
 * kableExtra [@kableExtra]
 * knitr [@knitr]
 * lubridate [@lubridate]
 * rmarkdown [@rmarkdown]

## Session info

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
