---
params:
  subtitle: ""
  title: ""
  authors: ""
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r getRunDateTime()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
bibliography: '`r paste0(here::here(), "/bibliography.bib")`'
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```


```{r codeSetup, include=FALSE}
# Set start time ----
startTime <- proc.time()
# Local parameters ----
b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576
plotLoc <- paste0(repoParams$repoLoc, "/docs/plots/") # where to put the plots (if any)

# Packages used in the report ----
libs <- c("ggplot2", # plots
          "kableExtra", # fancy tables
          "hms", # times
          "skimr" # for skim
          )
          
# Local functions ----
```

\newpage

# About

## Citation

```{r citation, child=repoParams$citation}
```

## Report circulation:

 * Public â€“ this report is intended for publication.
 
## License

```{r ccby license, child=repoParams$licenseCCBY}
```
 
## History

```{r history, child=repoParams$history}
```
 * this [report's edit history](https://github.com/CfSOtago/GREENGridEECA/commits/master/reports/partB_dataAnalysis)
 
## Support

```{r generic support, child=repoParams$support}
```
 
\newpage

# Introduction

This report uses the GREEN Grid project [@stephenson_smart_2017] research data to...

# Data

```{r generic sample, child=repoParams$data}
```

```{r Part B: data processing}
# put all this here before you report on it
# this code _could_ go in the makeFile if you want...

#New DT
powerDT <- copy(origPowerDT) # need to copy as data.table works by reference https://www.rdocumentation.org/packages/data.table/versions/1.12.2/topics/copy

#DT modifications

#Excluding households based on report
exclude <- c("rf_14", "rf_25", "rf_26", "rf_43", "rf_46")
powerDT[!(linkID %in% exclude)]

# setting negative values to NA
powerDT[, meanPowerW := ifelse(meanPowerW <0, NA, meanPowerW)]
powerDT[, sdPowerW := ifelse(sdPowerW <0, NA, sdPowerW)]
powerDT[, minPowerW := ifelse(minPowerW <0, NA, minPowerW)]
powerDT[, maxPowerW := ifelse(maxPowerW <0, NA, maxPowerW)]

# set to NZ time from UTC
powerDT[, r_dateTime_nz := lubridate::as_datetime(r_dateTimeHalfHour, 
                                               tz = "Pacific/Auckland")] # this will be UTC unless you set this

#Define Winter/else
powerDT[, date := lubridate::date(r_dateTime_nz)]
powerDT[, obsHalfHour := hms::as.hms(r_dateTime_nz)]
#powerDT[, obsHalfHour := format(ymd_hms(r_dateTimeHalfHour), "%H:%M:%S")]
powerDT[, month := lubridate::month(r_dateTime_nz)]

powerDT[month >= 12 | month == 1 | month == 2, season := "Summer"]
powerDT[month >= 3 | month == 4 | month == 5, season := "Autumn"]
powerDT[month == 6 | month == 7 | month == 8, season := "Winter"]
powerDT[month == 9 | month == 10 | month == 11, season := "Spring"]

#Setting times of peak demand 
OPS1 <- hms::as.hms("00:00:00")
OPE1 <- hms::as.hms("16:30:00")

PS <- hms::as.hms("17:00:00")
PE <- hms::as.hms("21:00:00")

OPS2 <- hms::as.hms("21:30:00")
OPE2 <- hms::as.hms("23:30:00")
#----------------------------
#Actual calculations start
#----------------------------

```

```{r Part B: calculations}

proDT <- origDT

proDT <- proDT[, test := ifelse(season == 'Winter' & obsHalfHour >= '17:00:00' & obsHalfHour <= '21:00:00', sum(meanPowerW), 0), keyby = .(circuit, obsHalfHour)]
  
proDT <- proDT[!(proDT$test==0), keyby =.(circuit, obsHalfHour)]
proDT <- proDT[, .(test = test), 
                    keyby = .(circuit, obsHalfHour)]










```

# Peak Contribution

```{r peakContrib}
# use origPowerDT 
```

# Annual Contribution

# Conservation Load Factor

# Summary

# Data Annex

Descriptive statistics for aggregate half hourly power data for all households and all circuits:

```{r skimData}
skimr::skim(origPowerDT)
```

The following tables show descriptive statistics for the meanPowerW values for each circuit by household.

```{r powerCube, results = "asis"}
ids <- unique(origPowerDT$linkID)

for(hh in ids){
  # prints a lot of tables
    t <- data.table::cube(origPowerDT[linkID == hh], j = c(list(meanPowerW = mean(meanPowerW),
                                                              minPowerW = min(meanPowerW),
                                                              maxPowerW = max(meanPowerW),
                                                              nObs = .N)), by = c("circuit"))
    # NA in circuit column of ersults table = All
    t[, circuit := ifelse(is.na(circuit), "All", circuit)]
    print(kableExtra::kable(t, caption = paste0(hh, ": Mean of half-hourly mean power (W) by circuit type")))
}

```

# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime
elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

## R packages used

 * base R [@baseR]
 * bookdown [@bookdown]
 * data.table [@data.table]
 * ggplot2 [@ggplot2]
 * kableExtra [@kableExtra]
 * knitr [@knitr]
 * lubridate [@lubridate]
 * rmarkdown [@rmarkdown]

## Session info

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
