---
params:
  subtitle: ""
  title: ""
  authors: ""
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r getRunDateTime()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r paste0(here::here(), "/bibliography.bib")`'
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```


```{r codeSetup, include=FALSE}
# Set start time ----
startTime <- proc.time()
# Local parameters ----
b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576
plotLoc <- paste0(repoParams$repoLoc, "/docs/plots/") # where to put the plots

# Packages used in the report ----
rmdLibs <- c("ggplot2", # plots
          "kableExtra", # fancy tables
          "lubridate"
          )
GREENGridEECA::loadLibraries(rmdLibs)
# Local functions ----
```

\newpage

# About

## Citation

```{r citation, child=repoParams$citation}
```

## Report circulation

 * Public – this report is intended for publication following EECA approval.
 
## License {#license}

```{r ccby license, child=repoParams$licenseCCBY}
```
 
## History

```{r history, child=repoParams$history}
```
 * this [report's edit history](https://github.com/CfSOtago/GREENGridEECA/commits/master/reports/partA_dataProcessing)
 
## Support

```{r generic support, child=repoParams$support}
```
 
\newpage

# Introduction

Previous work conducted as part of this project has calculated the % contribution to peak power load (kW) and to overall annual consumption (kWh) for the ~ 40 New Zealand GREEN Grid household electricity demand study dwellings [@stephenson_smart_2017].

EECA have expressed an interest in understanding how these results and/or this sample of dwellings can be scaled up to provide estimates of the same values for the overall New Zealand residential dwelling stock/household population.

As is described in the [archived data package](https://cfsotago.github.io/GREENGridData/overviewReport_v1.0.html#4_study_recruitment), the New Zealand GREEN Grid household electricity demand study sample dwellings are unlikely to be representative of neither the two regions from which they were drawn nor New Zealand as a whole. In addition they form an extremely small sample. In combination, these two issues make it unlikely that upscaling the sample to represent the regions from which they were drawn and/or the national household population would produce very robust estimates unless we assume that the household population of interest will behave in more or less the same way. Whilst this assumption may be plausible in the case of, say, lighting, it is likely to be implausible in the case of space or hot water heating due to the spatial distribution of reticulated gas and the use of coal/wood as main energy sources. Neither of the latter are represented in the GREEN Grid dwelling sample _at all_.

Nevertheless it is still useful to review potential upscaling methods should we wish to make assumptions of this kind or for a future time when a larger and representative sample of New Zealand household's energy consumption data is available. It is possible, for example, that BRANZ's planned new Household Energy End-Use Project ([HEEP](https://www.branz.co.nz/heep)) version 2 could provide just such a data source.

The remainder of this report therefore introduces two potential upscaling methods both of which have been used with the GREEN Griod household electricity demand data in different ways and for different purposes. The first is a simple multiplication method used to estimate overall residential electricity consumption for comparison to the GXP level data used in [Part B](https://cfsotago.github.io/GREENGridEECA/partB_dataAnalysisReport_v1.0.html#42_regionnetwork_coincident_peak). The second is a simple proportionate upscaling method used to estimate energy demand for heat pumps in New Zealand [@dortans_estimating_2019]. The third is a more complex re-weighting approach that uses iterative proportional fitting [simpson_combining_2005; @anderson_estimating_2012] to re-weight households on multiple dimensions to match known Census distributions [@anderson_small_2019].

# Data

A number of data sources are used in this report.

## Census 2013

```{r nNzHH}
# 2013
# 1,549,890
# http://archive.stats.govt.nz/Census/2013-census/profile-and-summary-reports/qstats-families-households/households.aspx
# basically matches sum(ipfCensusDT$npeople_totalHouseholds, na.rm = TRUE)
nzHhPop2013 <- sum(ipfCensusDT$npeople_totalHouseholds, na.rm = TRUE)

# 2015
# http://archive.stats.govt.nz/browse_for_stats/population/estimates_and_projections/DwellingHouseholdEstimates_HOTPJun17qtr.aspx
# 30 June 2017
nzHhPop2015 <- 1796000

# 
hhGrowth <- (100*(nzHhPop2015/nzHhPop2013)) - 100
```


This data comprises family, household or dwelling counts (depending on the variables of interest) at area unit level. The data was downloaded from the Stats NZ census table [download tool](http://nzdotstat.stats.govt.nz/wbos/index.aspx) and processed using [code](https://git.soton.ac.uk/ba1e12/spatialec/blob/master/dataProcessing/processCensusAu2013.Rmd) developed as part of the EU H2020 Marie Skłodowska-Curie scheme-funded [SPATIALEC](http://www.energy.soton.ac.uk/tag/spatialec/) Global Fellowship hosted by the University of Otago.

## Grid exit point kWh export (GXP)

```{r readdGxpData}
gxpDataDT <- drake::readd(gxpData) # gxp data
gxpDataDT[, hms := hms::as_hms(rDateTime)]
gxpDataDT <- GREENGridEECA::addNZSeason(gxpDataDT)
gxpDataDT[, year := lubridate::year(date)]
```


This data comprises the half-hourly electricity export (kWh) data for each New Zealand Grid Exit Point for [2015](https://cfsotago.github.io/GREENGridEECA/gxpReport_v0.5.html) downloaded from the Electricity Authority EMI [grid export database](https://www.emi.ea.govt.nz/Wholesale/Datasets/Metered_data/Grid_export). We use this data to provide _total_ electricity consumption levels against which we can compare our various residential consumption estimates.

## NZ GREEN Grid Household Electricity Demand {ggSample}

```{r readdGgPower}

fix <- function(dt){
  dt[, r_dateTimeHalfHour := lubridate::as_datetime(r_dateTimeHalfHour, tz = "Pacific/Auckland")]
  dt[, date := lubridate::date(r_dateTimeHalfHour)]
  dt[, hms := hms::as_hms(r_dateTimeHalfHour)]
  dt <- GREENGridEECA::addNZSeason(dt, date = date)
  dt[, meankWh := (meanPowerW/1000)/2] # convert to kW & divide by 2 as half-hours
}
# Total load
hhTotalLoadDT <- fix(drake::readd(ggHHData))

# HP
hhHeatPumpLoadDT <- fix(drake::readd(ggHPData))
```

This sample comprises 44 households who were recruited via the local power lines companies in two areas: Taranaki starting in May 2014 and Hawkes Bay starting in November 2014 [@GREENGridData].

> XX Should this content go in the Part B report to prevent readers of Part B thinking the results are likely to be representative of all NZ dwellings?

Recruitment was via a non-random sampling method and a number of households were intentionally selected for their ‘complex’ electricity consumption (and embedded generation) patterns and appliances [@dianaThesis2015; @stephenson_smart_2017; @jack_minimal_2018; @suomalainen_detailed_2019].

The lines companies invited their own employees and those of other local companies to participate in the research and ~80 interested potential participants completed short or long forms of the Energy Cultures 2 household survey [@ec2Survey2015]. Households were then selected from this pool by the project team based on selection criteria relevant to the GREEN Grid project. These included:

 * having the majority of their energy supply from electricity (i.e. not gas heating);
 * presence of children;
 * family and dwelling size;
 * types of appliances owned.

As a result of this process the sample cannot be assumed to represent the population of customers (or employees) of any of the companies involved, nor the populations in each location or New Zealand dwellings as a whole [@stephenson_smart_2017].

### Heating

As an example Figure \@ref(fig:ggHeatSource) compares the 'main method of heating' for the GREEN Grid sample with the results from the BRANZ Housing Conditions Survey 2015 [@vicki_white_warm_2017] where comparable. As we can see the GREEN Grid sample has a higher use of heat pumps compared to the HCS 2015 estimate of 40% heat pump penetration for owner occupied dwellings (the most similar to the GREEN Grid sample) and 25% for rentals. On the other hand, 25% of the GREEN Grid sample used enclosed woodburners as a main method of heating compared to HCS 2015 estimates of 39% and 23% for owner-occupied and rental dwellings respectively. Relatively few GREEN Grid dwellings used portable electric and none used portable gas heaters compared to the HCS 2015 sample.

These results suggest that the pattern of electricity use for space heating in the GREEN Grid sample is unlikely to be representative of all New Zealand dwellings.

```{r ggHeatSource, fig.cap = "Comparison of GREEN Grid and HCS 2015 heating appliance ownership rates"}
t <- with(hhAttributesDT, table(Q20_coded, useNA = "always"))
pc_t <- 100*prop.table(t)
pc_dt <- setnames(as.data.table(pc_t), "N", "pc")
setkey(pc_dt, Q20_coded)
dtf <- as.data.table(t)
setkey(dtf, Q20_coded)
dt <- dtf[pc_dt]
# kableExtra::kable(caption = paste0("Main method of heating, n dwellings = ", sum(dt$N)), 
#                   dt, digits = 2) %>%
#   kable_styling()

# compare to HCS 2015

setnames(pc_dt, "Q20_coded", "Appliance")
pc_dt[,type := "GREEN Grid sample"]
pc_dt[,ci_95pc := NA]
# keep comparables for clarity
r_pc_dt <- pc_dt[Appliance == "Heat pump" |
        Appliance == "Enclosed wood burner" |
        Appliance == "Portable electric heaters" |
        Appliance == "Portable gas heaters"]

combined_dt <- rbind(r_pc_dt,hcs2015DT)

dodge <- position_dodge(width=0.9)
# https://ggplot2.tidyverse.org/reference/geom_linerange.html
ggplot2::ggplot(combined_dt, aes(x = Appliance , y = pc, fill = type)) +
  geom_col(position = "dodge") +
  scale_fill_discrete(name = "Sample:") +
  geom_errorbar(aes(ymin = pc-ci_95pc, ymax = pc+ci_95pc), position = dodge, width = 0.25) +
  coord_flip() +
  theme(legend.position = "bottom") +
  labs(x = "Appliance", y = "%",
       caption = "Non-comparable appliances excluded, within-sample totals will not sum to 100%\nError bars = 95% CI for HCS 2015")


```

>Insert footnote re HCS 2015 confidence intervals of +/-6.1% for owner-occupier homes and +/-10.8% for rentals at the 95% level [@vicki_white_warm_2017,p51]. This means that if we repeated the HCS 100 times we would expect that in 95 of them the % of owner occupier dwellings with heat pumps would be between 33.9% and 46.1% and the figure for rentals would be 14.2% to 35.8%. Clearly the small sample size of the HCS 2015 leads to substantial uncertainty in the estimates of heat pump prevalance (and all other estimates) in these groups. For a more detailed discussion of this problem see [@anderson_ensuring_2020].

Further, Table \@ref(tab:compareheatSource) compares the 'Fuel type used to heat dwelling' for Census 2013 and the 'methods available for heating your house' in the GREEN Grid sample. Note that mutiple responses were possible in both data sources and we have [coded](https://git.soton.ac.uk/ba1e12/spatialec/blob/master/dataProcessing/processGreenGridSurvey.R) the responses to be as comparable as possible.
 
```{r compareheatSource}
# census
ct <- ipfCensusDT[, .(Electricity = sum(heatSourceElectricity, na.rm = TRUE),
                     Gas = sum(heatSourceGas,na.rm = TRUE),
                     Wood = sum(heatSourceWood,na.rm = TRUE),
                     Coal = sum(heatSourceCoal,na.rm = TRUE),
                     Other = sum(heatSourceOther,na.rm = TRUE)
                     )
                  ]
pc_ct <- 100*prop.table(ct)

# get census household counts per type
crt <- ipfCensusDT[, .(ElectricityT = sum(heatSourceElectricity, na.rm = TRUE),
                       GasT = sum(heatSourceGas,na.rm = TRUE),
                       WoodT = sum(heatSourceWood,na.rm = TRUE),
                       CoalT = sum(heatSourceCoal,na.rm = TRUE),
                       OtherT = sum(heatSourceOther,na.rm = TRUE),
                       Total = sum(fuel_totalHouseholds, na.rm = TRUE )
                       ), 
                   keyby = .(Region = REGC2013_label)
                   ]
# % of total (will sum to > 100 as multiple responses possible)
crt_pc <- crt[, .(Region,
                  Electricity = 100*(ElectricityT/Total),
                     Gas = 100*(GasT/Total),
                     Wood = 100*(WoodT/Total),
                     Coal = 100*(CoalT/Total),
                     Other = 100*(OtherT/Total)
                  )
              ]
# get survey counts
hhAttributesDT[, Electricity := ifelse(Q19_1 == 1 | # Heat pump
                                         Q19_2 == 1 | # Night store
                                         Q19_3 == 1 | # Portable elec
                                         Q19_4 == 1 | # Fixed elec
                                         Q19_10 == 1 | # elec CH
                                         Q19_10.1 == 1 | # elec DVS - typo?
                                         Q19_12 == 1 | # elec HRV
                                         Q19_13 == 1 ,  # elec UFH
                                       1, 0)]
hhAttributesDT[, Gas := ifelse(Q19_7 == 1 | # Portable gas heater
                                         Q19_8 == 1 | # Fixed gas heater
                                         Q19_9 == 1 | # Gas CH
                                         Q19_14 == 1 , # Gas UFH
                                       1, 0)]
hhAttributesDT[, Wood := ifelse(Q19_6 == 1 | # wood burner
                                         Q19_17 == 1,  # pellets
                                       1, 0)]
hhAttributesDT[, Coal := ifelse(Q19_5 == 1 , # coal burner
                                       1, 0)]
hhAttributesDT[, Other := ifelse(Q19_15 == 1 | # open fire
                                         Q19_16 == 1 , # Fixed elec
                                       1, 0)]

ht <- hhAttributesDT[, .(Electricity = sum(Electricity, na.rm = TRUE),
                       Gas = sum(Gas,na.rm = TRUE),
                       Wood = sum(Wood,na.rm = TRUE),
                       Coal = sum(Coal,na.rm = TRUE),
                       Other = sum(Other,na.rm = TRUE)
                       )
                   ]

# ht <- ipfSurveyDT[, .(Electricity = sum(heatSourceElectricity, na.rm = TRUE),
#                      Gas = sum(heatSourceGas,na.rm = TRUE),
#                      Wood = sum(heatSourceWood,na.rm = TRUE),
#                      Coal = sum(heatSourceCoal,na.rm = TRUE),
#                      Other = sum(heatSourceOther,na.rm = TRUE)
#                      )
#                   ]

# % of total (will sum to > 100 as multiple responses possible)
pc_ht <- 100*prop.table(ht)
pc_ct$source <- "Census 2013 (all regions)"
pc_ht$source <-"GREEN Grid sample"
setnames(crt_pc, "Region", "source") # fix var names
extract <- crt_pc[source  %like% "Taranaki" | source %like% "Hawke", 
                  .(Electricity = mean(Electricity),
                    Gas = mean(Gas),
                    Coal = mean(Coal),
                    Wood = mean(Wood),
                    Other = mean(Other),
                    source = "Census 2013 (Taranaki & Hawke's Bay only)"
                    )]
t <- rbind(pc_ct, # total census data
           extract, # regions
           pc_ht) # GG

kableExtra::kable(t, digits = 2, 
                  caption = "Comparing heating fuel used/methods available (% of dwellings)") %>%
  kable_styling() %>%
  footnote(general = "Row totals may sum to more than 100% due to multiple responses\nOpen fire is coded as 'Other' in GREEN Grid - it is not clear how this is coded in the Census data")
```

Table \@ref(tab:compareheatSource) shows that the GREEN Grid sample has a similar 'available fuel' profile to New Zealand dwellings as a whole but is not representative of the combined regions of Taranaki and Hawke's Bay from which it was drawn. In particular there are lower rates of Gas and Wood and much higher 'Other' although as noted the latter may be a coding artefact.

### Number of rooms

Table \@ref(tab:nRooms) shows the distribution of the number of rooms per household and shows that the GREEN Grid sample has fewer smaller dwellings and more larger dwellings than both New Zealand as a whole and the combined regions from which the sample is drawn.

```{r nRooms}

# census
ct <- ipfCensusDT[, .(nRooms1_4 = sum(nRooms1_4, na.rm = TRUE),
                     nRooms5_6 = sum(nRooms5_6,na.rm = TRUE),
                     nRooms7m = sum(nRooms7m,na.rm = TRUE)
                     )
                  ]
pc_ct <- 100*prop.table(ct)

# get census household counts per type
crt <- ipfCensusDT[, .(nRooms1_4t = sum(nRooms1_4, na.rm = TRUE),
                       nRooms5_6t = sum(nRooms5_6,na.rm = TRUE),
                       nRooms7mt = sum(nRooms7m,na.rm = TRUE),
                       Total = sum(nrooms_totalHouseholds, na.rm = TRUE )
                       ), 
                   keyby = .(Region = REGC2013_label)
                   ]
# % of total (will sum to > 100 as multiple responses possible)
crt_pc <- crt[, .(Region,
                  nRooms1_4 = 100*(nRooms1_4t/Total),
                     nRooms5_6 = 100*(nRooms5_6t/Total),
                     nRooms7m = 100*(nRooms7mt/Total)
                  )
              ]
# get survey counts
ht <- ipfSurveyDT[, .(nRooms1_4 = sum(nRooms1_4, na.rm = TRUE),
                       nRooms5_6 = sum(nRooms5_6,na.rm = TRUE),
                       nRooms7m = sum(nRooms7m,na.rm = TRUE)
                       )
                   ]

# % of total (will sum to > 100 as multiple responses possible)
pc_ht <- 100*prop.table(ht)
pc_ct$source <- "Census 2013 (all regions)"
pc_ht$source <-"GREEN Grid sample"
setnames(crt_pc, "Region", "source") # fix var names
extract <- crt_pc[source  %like% "Taranaki" | source %like% "Hawke", 
                  .(nRooms1_4 = mean(nRooms1_4),
                    nRooms5_6 = mean(nRooms5_6),
                    nRooms7m = mean(nRooms7m),
                    source = "Census 2013 (Taranaki & Hawke's Bay only)"
                    )]
t <- rbind(pc_ct, # total census data
           extract, # regions
           pc_ht) # GG

kableExtra::kable(t, digits = 2, 
                  caption = "Comparing number of rooms per dwelling (% of dwellings)") %>%
  kable_styling() 

```


### Number of people

Table \@ref(tab:nPeople) shows the distribution of number of people per household and shows thst the GREEN grid sample has far lower proportions of single or 2 person households than either the 2013 Census as a whole or the two regions but a much higher proportion of larger households. Since electricity demand is well known to correlate with the number of occupants [@huebner_explaining_2016] we would therefore expect average per dwelling/household GREEn Grid sample demand (or consumption) values to be overestimates.

```{r nPeople}

# census
ct <- ipfCensusDT[, .(nPeople_1 = sum(nPeople_1, na.rm = TRUE),
                     nPeople_2 = sum(nPeople_2,na.rm = TRUE),
                     nPeople_3 = sum(nPeople_3,na.rm = TRUE),
                     nPeople_4m = sum(nPeople_4m,na.rm = TRUE)
                     )
                  ]
pc_ct <- 100*prop.table(ct)

# get census household counts per type
crt <- ipfCensusDT[, .(nPeople_1 = sum(nPeople_1, na.rm = TRUE),
                     nPeople_2 = sum(nPeople_2,na.rm = TRUE),
                     nPeople_3 = sum(nPeople_3,na.rm = TRUE),
                     nPeople_4m = sum(nPeople_4m,na.rm = TRUE),
                     Total = sum(npeople_totalHouseholds, na.rm = TRUE )
                       ), 
                   keyby = .(Region = REGC2013_label)
                   ]
# % of total (will sum to > 100 as multiple responses possible)
crt_pc <- crt[, .(Region,
                  nPeople_1 = 100*(nPeople_1/Total),
                     nPeople_2 = 100*(nPeople_2/Total),
                     nPeople_3 = 100*(nPeople_3/Total),
                  nPeople_4m = 100*(nPeople_4m/Total)
                  )
              ]
# get survey counts
ht <- ipfSurveyDT[, .(nPeople_1 = sum(nPeople_1, na.rm = TRUE),
                     nPeople_2 = sum(nPeople_2,na.rm = TRUE),
                     nPeople_3 = sum(nPeople_3,na.rm = TRUE),
                     nPeople_4m = sum(nPeople_4m,na.rm = TRUE)
                       )
                   ]

# % of total (will sum to > 100 as multiple responses possible)
pc_ht <- 100*prop.table(ht)
pc_ct$source <- "Census 2013 (all regions)"
pc_ht$source <-"GREEN Grid sample"
setnames(crt_pc, "Region", "source") # fix var names
extract <- crt_pc[source  %like% "Taranaki" | source %like% "Hawke", 
                  .(nPeople_1 = mean(nPeople_1),
                    nPeople_2 = mean(nPeople_2),
                    nPeople_3 = mean(nPeople_3),
                    nPeople_4m = mean(nPeople_4m),
                    source = "Census 2013 (Taranaki & Hawke's Bay only)"
                    )]
t <- rbind(pc_ct, # total census data
           extract, # regions
           pc_ht) # GG

kableExtra::kable(t, digits = 2, 
                  caption = "Comparing number of people per dwelling (% of dwellings)") %>%
  kable_styling() 

```

### Number of children

Finally, table \@ref(tab:nKids) shows the distribution of 0 vs 1+ children per household. As expected, the GREEN grid sample has fewer hosueholds with no children and far more households with children than the population as a whole and this is also true for the two regions. Again, we would therefore expect average per dwelling/household GREEn Grid sample demand (or consumption) values to be differ substantially from the true values.

```{r nKids}

# census
ct <- ipfCensusDT[, .(nKids_0 = sum(nKids_0, na.rm = TRUE),
                     nKids_1m = sum(nKids_1m,na.rm = TRUE)
                     )
                  ]
pc_ct <- 100*prop.table(ct)

# get census household counts per type
crt <- ipfCensusDT[, .(nKids_0 = sum(nKids_0_families, na.rm = TRUE),
                     nKids_1m = sum(nKids_1m,na.rm = TRUE),
                     Total = sum(nkids_totalFamilies, na.rm = TRUE )
                       ), 
                   keyby = .(Region = REGC2013_label)
                   ]
# % of total (will sum to > 100 as multiple responses possible)
crt_pc <- crt[, .(Region,
                  nKids_0 = 100*(nKids_0/Total),
                     nKids_1m = 100*(nKids_1m/Total)
                  )
              ]
# get survey counts
ht <- ipfSurveyDT[, .(nKids_0 = sum(nKids_0, na.rm = TRUE),
                     nKids_1m = sum(nKids_1m,na.rm = TRUE)
                       )
                   ]

# % of total (will sum to > 100 as multiple responses possible)
pc_ht <- 100*prop.table(ht)
pc_ct$source <- "Census 2013 (all regions)"
pc_ht$source <-"GREEN Grid sample"
setnames(crt_pc, "Region", "source") # fix var names
extract <- crt_pc[source  %like% "Taranaki" | source %like% "Hawke", 
                  .(nKids_0 = mean(nKids_0),
                    nKids_1m = mean(nKids_1m),
                    source = "Census 2013 (Taranaki & Hawke's Bay only)"
                    )]
t <- rbind(pc_ct, # total census data
           extract, # regions
           pc_ht) # GG

kableExtra::kable(t, digits = 2, 
                  caption = "Comparing number of households with 0 vs 1+ child per dwelling (% of dwellings)") %>%
  kable_styling() 

```

# Scaling examples

Setting aside the conclusion that the GREEN grid sample comprises more larger dwelings with more heat pumps, more occupants and more children than we would expect, in this section we use the GREEN Grid sample as a case study to help explain a number of scaling approaches. 

The range from simple multiplication through proportional multiplication to complex re-weighting schemes.

## Simple multiplication {#totLoadBasic}

Under this method we simple multiply an estimated value derived from the GREEN Grid 2015 sample by the inverse of the ratio of the GREEN Grid sample size to the national household population derived from [Census 2013](http://archive.stats.govt.nz/Census/2013-census/profile-and-summary-reports/qstats-families-households/households.aspx) (`r tidyNum(nzHhPop2013)`).

### Total electricity comsumption profiles - 2015 {totalLoad2015}

As an example let us assume we wish to calculate the total residential electricity consumption profiles by season for 2015 to estimate their contributon to overall electricity consumption profiles in New Zealand. To do this, we use the half-hourly total kW load data produced in [Part A](https://cfsotago.github.io/GREENGridEECA/partA_dataProcessingReport_v1.0.html#610_total_load) and calculate mean energy consumption (kWh) per half-hour for each season in 2015. We can then compare the results with the overall electricity consumption captured by the 2015 Grid Exit Point (GXP) data used in [Part B](https://cfsotago.github.io/GREENGridEECA/partB_dataAnalysisReport_v1.0.html#42_regionnetwork_coincident_peak).


```{r prepHHProfiles, fig.cap = "Mean kWh per half-hour by season"}

profileDT <- hhTotalLoadDT[, .(meankWh = mean(meankWh)), keyby = .(hms,season)]

# test
#profileDT[, .(mean = mean(meankWh)), keyby = .(season)]

ggplot(profileDT, aes(x = hms, y = meankWh, colour = season)) +
  geom_line() +
  labs(y = "Mean kWh per half-hour",
       x = "Time of Day",
       caption = paste0("N households: ", uniqueN(hhTotalLoadDT$linkID)))

winterMax <- round(max(profileDT[season == "Winter"]$meankWh),2)
```

Figure \@ref(fig:prepHHProfiles) shows the results of the intial sample-based profile calculation and we estimate that the maximum mean kWh per half-hour in winter in 2015 was ~ `r winterMax` kWh. If we multiply this by the number of households in estimated by the [2015 NZ Statistics household count projection](http://archive.stats.govt.nz/browse_for_stats/population/estimates_and_projections/DwellingHouseholdEstimates_HOTPJun17qtr.aspx) (`r tidyNum(nzHhPop2015)`) then we get a rough estimate of maximum mean residential kWh in winter as `r round((winterMax * nzHhPop2015)/1000000,2)` GWh.

Figure \@ref(fig:nationalProfiles2015) shows the simple upscaling of Figure \@ref(fig:prepHHProfiles) to the 2015 New Zealand household population by multiplying by the total number of households projected. 

```{r nationalProfiles2015, fig.cap = "Estimated total residential electricity consumption per half-hour by season (2015)"}
profileDT <- profileDT[, totalResMWh2015 := (meankWh * nzHhPop2015)/1000]
  
# test
#profileDT[, .(mean = mean(meankWh)), keyby = .(season)]

ggplot(profileDT, aes(x = hms, y = totalResMWh2015, colour = season)) +
  geom_line() +
  labs(y = "Total MWh per half-hour",
       x = "Time of Day",
       caption = paste0("Observed households: ", uniqueN(hhTotalLoadDT$linkID),
                        "\nRescaled to New Zealand households (2015): ", GREENGridData::tidyNum(nzHhPop2015)
                        )
       )
```

Figure \@ref(fig:compareGxp2015) shows these values as a % of the total network electricity export by season for all regions in 2015. We can see that the estimated % contribution of residential dwellings to peak time consumption is ~ 30% in summer but over 60% in winter. In the absence of any other data sources we are unable to comment on the plausibility of these estimates but 60% is likely to be a considerable over-estimate given the inherent bias of the GREEN Grid sample that was reported in Section \ref(#ggSample) above.

```{r compareGxp2015, fig.cap="Mean total kWh per half hour by season"}

myCaption <- paste0("Source: EA EMI Grid Exit Point (GXP) data 2015",
                    ", ", min(gxpDataDT$date, na.rm = TRUE)
                    , " - ", max(gxpDataDT$date, na.rm = TRUE))

gxpDT <- gxpDataDT[year == 2015, .(sumkWh = sum(kWh), meankWh = mean(kWh), 
                        nGXPs = uniqueN(MXLOCATION), nDays = uniqueN(date)), 
                    keyby = .(hms, season)]

gxpDT[,totDailyMWh := (sumkWh/(nDays))/1000]
setkey(gxpDT, hms, season)
setkey(profileDT, hms, season)

plotDT <- profileDT[gxpDT]
plotDT[, pc := 100 * (totalResMWh2015/totDailyMWh)]

ggplot(plotDT, aes(x = hms, y = pc, colour = season)) +
  geom_line() +
  labs(y = "% Total daily GXP MWh per half-hour",
       x = "Time of Day",
       caption = myCaption
       )
```

This approach illustrates the difficulty of producing robust national level using simple multiplication of a small and biased sample.

Clearly it would be possible to repeat this simple method using regional household counts for  Taranaki and Hawke's Bay respectively. However, in the apparent absence of regional level household projections we would be forced to use future Cennsus 2018 or historical Census 2013 regional household counts. The use of either of these would mean assuming that the temperature and other environmental conditions that affected electricity consumption in the GREEN Grid sample in 2015 were similar in 2018 or 2013 respectively. Neither of these is likely to be the case.

## Simple proportional scaling

In this method, rather than assume that the base (GREEN Grid) sample represents all New Zealand dwellings we proportionately adjust the profiles using some other data source. 

### Example: Heat pump electricity consumption
As an example, suppose we wanted to estimate the total seasonal electricity consumption profiles caused by heat pumps in 2015.

We know from the BRANZ HCS 2015 survey that 46% of owner-occupier dwellings have a heat pump compared to 25% for rentals but that in the 2015 GREEN Grid sample, `r round(combined_dt[type %like% "GREEN" & Appliance %like% "Heat"]$pc,2)`% have heat pumps.

In principle we could estimate heat pump electricty consumption profiles for the owner-occupier and rental dwellings in the GREEN Grid sample and then multiply by the proportion of dwellings of each type in New Zealand as recorded by the 2013 Census. In doing so we would have to assume that the proportions of owner-occupied to rental dwellings had remained constant from 2013 to 2015.

Unfortunately, as Table \@ref(tab:ggTenure) shows, over 90% of GREEN Grid dwellings were owner-occupied and so this approach not feasible. 

```{r ggTenure}
hhAttributesDT[, hasHeatPump := ifelse(Q20_coded == "Heat pump", "Yes", "No")]
t <- table(hhAttributesDT$Q12_coded, hhAttributesDT$hasHeatPump)

kableExtra::kable(100*prop.table(t), digits = 1,
                  caption = "% dwellings in GREEN Grid sample with/without heat pumps by tenure") %>%
  kable_styling()
```

Instead, we calculate the overall mean electricity consumption profiles for heat pump circuits. We then multiply these values by the number of dwellings we presume to have heat pumps (irrespective of tenure) calculated by applying HCS 2015 rates to the 2015 household estimate introduced in Section \ref(#totalLoad2015)

Summarise relevant [@dortans_estimating_2019] section

```{r prepHpProfiles, fig.cap = "Mean Heat Pump kWh per half-hour by season"}

profileHpDT <- hhHeatPumpLoadDT[, .(meankWh = mean(meankWh)), keyby = .(hms,season)]

# test
#profileDT[, .(mean = mean(meankWh)), keyby = .(season)]

ggplot(profileHpDT, aes(x = hms, y = meankWh, colour = season)) +
  geom_line() +
  labs(y = "Mean kWh per half-hour",
       x = "Time of Day",
       caption = paste0("N households: ", uniqueN(hhHeatPumpLoadDT$linkID)))

winterHpMax <- round(max(profileHpDT[season == "Winter"]$meankWh),2)
```

Figure \@ref(fig:prepHpProfiles) shows the results of the intial sample-based profile calculation and we estimate that the maximum mean kWh per half-hour in winter in 2015 was ~ `r winterHpMax` kWh. As before, if we multiply this by the number of households in estimated by the [2015 NZ Statistics household count projection](http://archive.stats.govt.nz/browse_for_stats/population/estimates_and_projections/DwellingHouseholdEstimates_HOTPJun17qtr.aspx) (`r tidyNum(nzHhPop2015)`) then we get a rough estimate of maximum mean residential kWh in winter as `r round((winterMax * nzHhPop2015)/1000000,2)` GWh.

```{r tenure2015}
prHouseholdsRent <- 453135/nzHhPop2015 # http://archive.stats.govt.nz/Census/2013-census/profile-and-summary-reports/quickstats-about-housing/households-who-rent.aspx
prHouseholdsOwn <- 0.648 # 64.8% http://archive.stats.govt.nz/Census/2013-census/profile-and-summary-reports/quickstats-about-housing/home-ownership-households.aspx
```

Figure \@ref(fig:nationalProfiles2015) shows the simple upscaling of Figure \@ref(fig:prepHHProfiles) to the 2015 New Zealand household population by multiplying by the total number of households projected. 

```{r nationalHpProfiles2015, fig.cap = "Estimated total residential electricity consumption per half-hour by season (2015)"}


profileHpDT <- profileHpDT[, totalHpMWh2015 := (meankWh * nzHhPop2015)/1000]
  
# test
#profileDT[, .(mean = mean(meankWh)), keyby = .(season)]

ggplot(profileDT, aes(x = hms, y = totalHpMWh2015, colour = season)) +
  geom_line() +
  labs(y = "Total MWh per half-hour",
       x = "Time of Day",
       caption = paste0("Observed households: ", uniqueN(profileHpDT$linkID),
                        "\nRescaled to New Zealand households (2015): ", GREENGridData::tidyNum(nzHhPop2015)
                        )
       )
```

Figure \@ref(fig:compareGxp2015) shows these values as a % of the total network electricity export by season for all regions in 2015. We can see that the estimated % contribution of residential dwellings to peak time consumption is ~ 30% in summer but over 60% in winter. In the absence of any other data sources we are unable to comment on the plausibility of these estimates but 60% is likely to be a considerable over-estimate given the inherent bias of the GREEN Grid sample that was reported in Section \ref(#ggSample) above.

```{r compareGxp2015, fig.cap="Mean total kWh per half hour by season"}

myCaption <- paste0("Source: EA EMI Grid Exit Point (GXP) data 2015",
                    ", ", min(gxpDataDT$date, na.rm = TRUE)
                    , " - ", max(gxpDataDT$date, na.rm = TRUE))

gxpDT <- gxpDataDT[year == 2015, .(sumkWh = sum(kWh), meankWh = mean(kWh), 
                        nGXPs = uniqueN(MXLOCATION), nDays = uniqueN(date)), 
                    keyby = .(hms, season)]

gxpDT[,totDailyMWh := (sumkWh/(nDays))/1000]
setkey(gxpDT, hms, season)
setkey(profileDT, hms, season)

plotDT <- profileDT[gxpDT]
plotDT[, pc := 100 * (totalResMWh2015/totDailyMWh)]

ggplot(plotDT, aes(x = hms, y = pc, colour = season)) +
  geom_line() +
  labs(y = "% Total daily GXP MWh per half-hour",
       x = "Time of Day",
       caption = myCaption
       )
```


### Summary

## Complex re-weighting

Briefly summarise iterative proportional fitting [simpson_combining_2005; @anderson_estimating_2012] to re-weight households on multiple dimensions to match known Census distributions [@anderson_small_2019].

describe approach and build ipf-based model of overall load for

 * Taranaki
 * Hawke's Bay
 * NZ
 
 using aggregated are unit Census data & half-hour kW/kWh data from Part A/B -> mean kW per half hour per season (using 2015) 

### Example: Total electricity consumption

re-run using method in [@anderson_small_2019]

```{r ipfTotalLoad}

```

### Example: Heat pump electricity consumption

re-run using method in [@anderson_small_2019]

### Sumary

# Overall summary and recommendations

This report has outlined a number of methods that could be used to upscale the GREEN Grid (or similar) household energy demand datasets to develop national or regional level residential demand or consumption estimates. However we have noted that in all cases the GREEN grid data is insufficient for this purpose due to:

 * its small size - meaning very small numbers of households would be 'representing' very large numbers in the true population;
 * its recruitment bias - meaning that some household types and some crucial energy source types (e.g. coal, wood-only, reticulated gas) are not represented at all and so cannot be 're-weighted'.
 
We have demonstrated this through a number of worked examples and suggest that future work could apply these methods to more suitable data sources such as:

 * the BRANZ [Housing Conditions Survey](https://www.branz.co.nz/hcs) datasets - although detailed energy monitoring was not included;
 * the recent NZ Stats/MBIE [Housing Quality Indicator survey](https://www.stats.govt.nz/methods/framework-for-housing-quality) - although detailed energy monitoring was not included;
 * the potential future BRANZ Household Energy End-Use (HEEP2) study;
 * representative smart meter datasets linked to household attributes;
 * imputed load profiles generated using New Zealand Time Use data (see [mckenna_high-resolution_2016;@mckenna_simulating_2017] for a UK exmple)

All code used to create this report is available from:

 * https://github.com/CfSOtago/GREENGridEECA
 
The archived and most recent version of the report is available from:
 
 * https://cfsotago.github.io/GREENGridEECA/


```{r runToEnd}

```

# Data Annex

## Census data summary 
Descriptive statistics for census data:

```{r skimCensusData}
#skimr::skim(censusDT)
```

## GREEN Grid half-hourly total load summary 
Descriptive statistics for dwelling power data:

```{r skimPowerData}
#skimr::skim(powerDT)
```

## GREEN Grid household data summary 
Descriptive statistics for household data:

```{r skimHouseholdData}
#skimr::skim(householdDT)
```

# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime
elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

## R packages used

 * base R [@baseR]
 * bookdown [@bookdown]
 * data.table [@data.table]
 * ggplot2 [@ggplot2]
 * kableExtra [@kableExtra]
 * knitr [@knitr]
 * lubridate [@lubridate]
 * rmarkdown [@rmarkdown]

## Session info

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
