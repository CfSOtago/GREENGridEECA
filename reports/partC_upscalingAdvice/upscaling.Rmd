---
params:
  subtitle: ""
  title: ""
  authors: ""
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r getRunDateTime()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
    fig_width: 5
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r paste0(here::here(), "/bibliography.bib")`'
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
```


```{r codeSetup, include=FALSE}
# Set start time ----
startTime <- proc.time()
# Local parameters ----
b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576
plotLoc <- paste0(repoParams$repoLoc, "/docs/plots/") # where to put the plots

nzHhPop2015 <- 1796000

# Packages used in the report ----
rmdLibs <- c("ggplot2", # plots
          "kableExtra", # fancy tables
          "lubridate"
          )
GREENGridEECA::loadLibraries(rmdLibs)
# Local functions ----
```

\newpage

# About

## Citation

```{r citation, child=repoParams$citation}
```

## Report circulation

 * Public – this report is intended for publication following EECA approval.
 
## License {#license}

```{r ccby license, child=repoParams$licenseCCBY}
```
 
## History

```{r history, child=repoParams$history}
```
 * this [report's edit history](https://github.com/CfSOtago/GREENGridEECA/commits/master/reports/partA_dataProcessing)
 
## Support

```{r generic support, child=repoParams$support}
```
 
\newpage

# Introduction

Previous work conducted as part of this project has calculated the % contribution to peak power load (kW) and to overall annual consumption (kWh) for the ~ 40 New Zealand GREEN Grid household electricity demand study dwellings [@stephenson_smart_2017].

EECA have expressed an interest in understanding how these results and/or this sample of dwellings can be scaled up to provide estimates of the same values for the overall New Zealand residential dwelling stock/household population.

As is described in the [archived data package](https://cfsotago.github.io/GREENGridData/overviewReport_v1.0.html#4_study_recruitment), the New Zealand GREEN Grid household electricity demand study sample dwellings are unlikely to be representative of neither the two regions from which they were drawn nor New Zealand as a whole. In addition they form an extremely small sample. In combination, these two issues make it unlikely that upscaling the sample to represent the regions from which they were drawn and/or the national household population would produce very robust estimates unless we assume that the household population of interest will behave in more or less the same way. Whilst this assumption may be plausible in the case of, say, lighting, it is likely to be implausible in the case of space or hot water heating due to the spatial distribution of reticulated gas and the use of coal/wood as main energy sources. Neither of the latter are represented in the GREEN Grid dwelling sample _at all_.

Nevertheless it is still useful to review potential upscaling methods should we wish to make assumptions of this kind or for a future time when a larger and representative sample of New Zealand household's energy consumption data is available. It is possible, for example, that BRANZ's planned new Household Energy End-Use Project ([HEEP](https://www.branz.co.nz/heep)) version 2 could provide just such a data source.

The remainder of this report therefore introduces two potential upscaling methods both of which have been used with the GREEN Griod household electricity demand data in different ways and for different purposes. The first is a simple multiplication method used to estimate overall residential electricity consumption for comparison to the GXP level data used in [Part B](https://cfsotago.github.io/GREENGridEECA/partB_dataAnalysisReport_v1.0.html#42_regionnetwork_coincident_peak). The second is a simple proportionate upscaling method used to estimate energy demand for heat pumps in New Zealand [@dortans_estimating_2019]. The third is a more complex re-weighting approach that uses iterative proportional fitting [simpson_combining_2005; @anderson_estimating_2012] to re-weight households on multiple dimensions to match known Census distributions [@anderson_small_2019].

# Data

Explain data sources

## GXP

## GREEN Grid

This sample comprises 44 households who were recruited via the local power lines companies in two areas: Taranaki starting in May 2014 and Hawkes Bay starting in November 2014 [@GREENGridData].

Recruitment was via a non-random sampling method and a number of households were intentionally selected for their ‘complex’ electricity consumption (and embedded generation) patterns and appliances [@dianaThesis2015; @stephenson_smart_2017; @jack_minimal_2018; @suomalainen_detailed_2019].

The lines companies invited their own employees and those of other local companies to participate in the research and ~80 interested potential participants completed short or long forms of the Energy Cultures 2 household survey [@ec2Survey2015]. Households were then selected from this pool by the project team based on selection criteria relevant to the GREEN Grid project. These included:

 * having the majority of their energy supply from electricity (i.e. not gas heating);
 * household size;
 * types of appliances owned.

As a result of this process the sample cannot be assumed to represent the population of customers (or employees) of any of the companies involved, nor the populations in each location [@stephenson_smart_2017].

> some examples of this:
 
```{r heatSource}
t <- with(hhAttributesDT, table(Q20_coded, useNA = "always"))

pc_t <- 100*prop.table(t)

dt <- setnames(as.data.table(pc_t), "N", "%")

setkey(dt, Q20_coded)

dtf <- as.data.table(t)
setkey(dtf, Q20_coded)

dt <- dtf[dt]

kableExtra::kable(caption = paste0("Main heat source, n dwellings = ", sum(dt$N)), 
                  dt, digits = 2) %>%
  kable_styling()
```

```{r nBedrooms}
hhAttributesDT[, nBedrooms := `Q10#1_1_1_TEXT`]
t <- table(hhAttributesDT$nBedrooms,  useNA = "always")

pc_t <- 100*prop.table(t)

dt <- setnames(as.data.table(pc_t), c("N"), c("%"))

setkey(dt, V1)

dtf <- as.data.table(t)
setkey(dtf, V1)

dt <- dtf[dt]

setnames(dt, "V1", "N bedrooms")
kableExtra::kable(caption = paste0("Main heat source, n dwellings = ", sum(dt$N)), 
                  dt, digits = 2) %>%
  kable_styling()

```


```{r nPeople}
hhAttributesDT[, nPeople := nAdults + nChildren0_12 + nTeenagers13_18]
t <- table(hhAttributesDT$nPeople,  useNA = "always")

pc_t <- 100*prop.table(t)

dt <- setnames(as.data.table(pc_t), c("N"), c("%"))

setkey(dt, V1)

dtf <- as.data.table(t)
setkey(dtf, V1)

dt <- dtf[dt]

setnames(dt, "V1", "N people")
kableExtra::kable(caption = paste0("Main heat source, n dwellings = ", sum(dt$N)), 
                  dt, digits = 2) %>%
  kable_styling()

```


compare with (for e.g.) the BRANZ HCS results or Census 2013

## Census 2013

# Simple multiplication

## Example: Total electricity consumption {#totLoadBasic}

In this case we use the half-hourly total kW load data set produced in [Part A](https://cfsotago.github.io/GREENGridEECA/partA_dataProcessingReport_v1.0.html#610_total_load). To produce national estimates we first prepare the household level consumption data to provide mean energy consumption (kWh) per half-hour for each season in 2015. We use kWh to enable comparison with the GXP data used in [Part B](https://cfsotago.github.io/GREENGridEECA/partB_dataAnalysisReport_v1.0.html#42_regionnetwork_coincident_peak).

```{r prepHHProfiles, fig.cap = "Mean kWh per half-hour by season"}
hhTotalLoadDT[, meankWh := (meanPowerW/1000)/2] # convert to kW & divide by 2 as half-hours
hhTotalLoadDT[, r_dateTimeHalfHour := lubridate::as_datetime(r_dateTimeHalfHour, tz = "Pacific/Auckland")]
hhTotalLoadDT[, date := lubridate::date(r_dateTimeHalfHour)]
hhTotalLoadDT[, hms := hms::as_hms(r_dateTimeHalfHour)]
hhTotalLoadDT <- GREENGridEECA::addNZSeason(hhTotalLoadDT, date = date)
profileDT <- hhTotalLoadDT[, .(meankWh = mean(meankWh)), keyby = .(hms,season)]

# test
#profileDT[, .(mean = mean(meankWh)), keyby = .(season)]

ggplot(profileDT, aes(x = hms, y = meankWh, colour = season)) +
  geom_line() +
  labs(y = "Mean kWh per half-hour",
       x = "Time of Day",
       caption = paste0("N households: ", uniqueN(hhTotalLoadDT$linkID)))

winterMax <- round(max(profileDT[season == "Winter"]$meankWh),2)
```

Figure \@ref(fig:prepHHProfiles) shows the mean kWh per half hour for each season that we will use as the basis for the re-weighting process. We can therefore estimate that the maximum mean kWh per half-hour in winter is ~ `r winterMax` kWh. If we multiply this by the number of households in New Zealand as recorded by the 2013 Census (`r tidyNum(nzHhPop2015)`) then we get a rough estimate of maximum mean residential kWh in winter as `r round((winterMax * nzHhPop2015)/1000000,2)` GWh.

Figure \@ref(fig:nationalProfiles) shows the simple upscaling of Figure \@ref(fig:nationalProfiles) to the New Zealand household population by multiplying by the total number of households. 

```{r nationalProfiles, fig.cap = "Total residential electricity consumption per half-hour by season"}
profileDT <- hhTotalLoadDT[, .(meankWh = mean(meankWh)), keyby = .(hms,season)]
profileDT <- profileDT[, totalResMWh := (meankWh * nzHhPop2015)/1000]
  
# test
#profileDT[, .(mean = mean(meankWh)), keyby = .(season)]

ggplot(profileDT, aes(x = hms, y = totalResMWh, colour = season)) +
  geom_line() +
  labs(y = "Total MWh per half-hour",
       x = "Time of Day",
       caption = paste0("N observed households: ", uniqueN(hhTotalLoadDT$linkID),
                        "\nN New Zealand households: ", GREENGridData::tidyNum(nzHhPop2015)
                        )
       )
```

If we compare these results with the total derived from the GXP data for 2015 used in [Part B](https://cfsotago.github.io/GREENGridEECA/partB_dataAnalysisReport_v1.0.html#42_regionnetwork_coincident_peak) then we can see XXX


Figure \@ref(fig:profiles) shows these values as a % of the total network electricity export by season for all regions combined as a data sense-check. As we can see the naive multiplication method produces broadly plausible results in summer where we estimate ~30%-40% of total electricity consumption in peak periods is due to households. However the method appears to substantially (and implausibly) over-estimate the contribution of households in winter peaks where the value approaches 70%. The is almost certainly due to the bias inherent in the GREEN Grid sample which had a higher proportion of families, households with higher incomes and no households using gas or solid fuels as a primary space heating energy source.

```{r profiles, fig.cap="Mean total kWh per half hour by season"}
myCaption <- paste0("Source: EA EMI Grid Exit Point (GXP) data",
                    ", ", min(gxpDataDT$date, na.rm = TRUE)
                    , " - ", max(gxpDataDT$date, na.rm = TRUE))
gxpDataDT[, hms := hms::as.hms(rDateTime)]
gxpDataDT <- GREENGridEECA::addNZSeason(gxpDataDT)

gxpDT <- gxpDataDT[, .(sumkWh = sum(kWh), meankWh = mean(kWh), 
                        nGXPs = uniqueN(node), nDays = uniqueN(date)), 
                    keyby = .(hms, season)]
gxpDT[,totDailyMWh := (sumkWh/(nDays))/1000]
setkey(gxpDT, hms, season)
setkey(profileDT, hms, season)

plotDT <- profileDT[gxpDT]
plotDT[, pc := 100 * (totalResMWh/totDailyMWh)]

ggplot(plotDT, aes(x = hms, y = pc, colour = season)) +
  geom_line() +
  labs(y = "% Total daily GXP MWh per half-hour",
       x = "Time of Day",
       caption = paste0("N observed households: ", uniqueN(hhTotalLoadDT$linkID),
                        "\nN New Zealand households: ", GREENGridData::tidyNum(nzHhPop2015)
                        )
       )
```

This approach illustrates the difficulty of producing robust national level using simple multiplication of a small and biased sample.

# Simple Proportional Upscaling

Summarise method used in [@dortans_estimating_2019]

## Example: Heat pump electricity consumption

Summarise relevant [@dortans_estimating_2019] section

## Summary

# Complex re-weighting

Briefly summarise iterative proportional fitting [simpson_combining_2005; @anderson_estimating_2012] to re-weight households on multiple dimensions to match known Census distributions [@anderson_small_2019].

describe approach and build ipf-based model of overall load for

 * Taranaki
 * Hawke's Bay
 * NZ
 
 using aggregated are unit Census data & half-hour kW/kWh data from Part A/B -> mean kW per half hour per season (using 2015) 

## Example: Total electricity consumption

re-run using method in [@anderson_small_2019]

## Example: Heat pump electricity consumption

re-run using method in [@anderson_small_2019]

## Sumary

# Overall summary and recommendations

This report has outlined a number of methods that could be used to upscale the GREEN Grid (or similar) household energy demand datasets to develop national or regional level residential demand or consumption estimates. However we have noted that in all cases the GREEN grid data is insufficient for this purpose due to:

 * its small size - meaning very small numbers of households would be 'representing' very large numbers in the true population;
 * its recruitment bias - meaning that some household types and some crucial energy source types (e.g. coal, wood-only, reticulated gas) are not represented at all and so cannot be 're-weighted'.
 
We have demonstrated this through a number of worked examples and suggest that future work could apply these methods to more suitable data sources such as:

 * the BRANZ [Housing Conditions Survey](https://www.branz.co.nz/hcs) datasets - although detailed energy monitoring was not included;
 * the recent NZ Stats/MBIE [Housing Quality Indicator survey](https://www.stats.govt.nz/methods/framework-for-housing-quality) - although detailed energy monitoring was not included;
 * the potential future BRANZ Household Energy End-Use (HEEP2) study;
 * representative smart meter datasets linked to household attributes;
 * imputed load profiles generated using New Zealand Time Use data (see [mckenna_high-resolution_2016;@mckenna_simulating_2017] for a UK exmple)

All code used to create this report is available from:

 * https://github.com/CfSOtago/GREENGridEECA
 
The archived and most recent version of the report is available from:
 
 * https://cfsotago.github.io/GREENGridEECA/


```{r runToEnd}

```

# Data Annex

## Census data summary 
Descriptive statistics for census data:

```{r skimCensusData}
#skimr::skim(censusDT)
```

## GREEN Grid half-hourly total load summary 
Descriptive statistics for dwelling power data:

```{r skimPowerData}
#skimr::skim(powerDT)
```

## GREEN Grid household data summary 
Descriptive statistics for household data:

```{r skimHouseholdData}
#skimr::skim(householdDT)
```

# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime
elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

## R packages used

 * base R [@baseR]
 * bookdown [@bookdown]
 * data.table [@data.table]
 * ggplot2 [@ggplot2]
 * kableExtra [@kableExtra]
 * knitr [@knitr]
 * lubridate [@lubridate]
 * rmarkdown [@rmarkdown]

## Session info

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
